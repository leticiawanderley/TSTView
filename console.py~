#  -*- coding: utf-8 -*-

import webapp2
from logica_report import get_data
from datetime import datetime, timedelta
import os
import jinja2
jinja_environment = jinja2.Environment(loader=jinja2.FileSystemLoader(os.path.dirname(__file__)))

DEBUG = False
IND_MATRICULA, IND_QUESTAO, NOME, IND_DATAHORA, IND_TESTE = 1, 2, 3, 4, 5

def processa_dados(datainicio, datafim, info):

	"""
	Recebe um pacote de dados (de um arquivo ou url) e processa
	transformando em 2 dicionarios. Dicionario matricula:
	'dicionario = {matricula: [submissao_total,matricula,questao,submissao,data+hora,teste]}'
	Dicionario questao:
	'dicionario = {questao: [sequencia de matriculas]}'
	"""

	dict_matriculas = {}
	dict_questoes = {}
	for linha in info:
		linha = linha.strip("\r\n").split(",")
		datahora_submissao = datetime(int(linha[IND_DATAHORA][6:10]), int(linha[IND_DATAHORA][3:5]), int(linha[IND_DATAHORA][:2]), int(linha[IND_DATAHORA][11:13]), int(linha[IND_DATAHORA][14:16]))
		if datainicio <= datahora_submissao <= datafim:

			matricula = linha[IND_MATRICULA]
			resultados = dict_matriculas.get(matricula, [])
			resultados.append(linha)
			dict_matriculas[matricula] = resultados

			questao = linha[IND_QUESTAO]
			submissoes = dict_questoes.get(questao, [])
			submissoes.append(linha[IND_MATRICULA])
			dict_questoes[questao] = submissoes

	return dict_matriculas, dict_questoes

def erro(string_teste):

	"""
	Checa, através da string do teste,
	se a questão tem erro
	"""

	error = False
	for caractere in string_teste:
		if caractere != ".":
			return True

	return error

def lista_submissoes(dict_mat, datainicio, datafim, turma_analisada, dict_alunos):
	
	"""
	Processa os dicionarios retornando uma tabela html
	com os dados das submissoes no periodo de tempo
	passado pelo usuario. No formato:
	'- Aluno:  sequencia de questoes'
	"""


	df = datetime.strftime(datafim, "%d%m%Y")
	lista_submissoes = []
	lista_template = jinja_environment.get_template("ConsoleTemplates/lista_submissoes.html")
	print_string = lista_template.render()
	for aluno in turma_analisada:
		nome_aluno = dict_alunos[aluno][NOME]
		print_string += """<tr onMouseover="this.bgColor='#DBDBDB';" onMouseout="this.bgColor='#FFFFFF';"><td onClick="document.location.href='/report?data=%s&df=%s&matriculas=%s';" style="cursor:pointer;cursor:hand" title="%s"><p>&nbsp;- <a style="color:blue; text-decoration:none">&nbsp;%s</a>:</td><td>""" % (datetime.strftime(datainicio, "%d%m%Y"), df, aluno, u"Matrícula: " + aluno + ". TT" + dict_alunos[aluno][1] + ", TP" + dict_alunos[aluno][2], nome_aluno)
		if aluno in dict_mat:
			for indice in range(len(dict_mat[aluno])-1,-1,-1):
				questao = "%03d" % int(dict_mat[aluno][indice][IND_QUESTAO])
				teste = dict_mat[aluno][indice][IND_TESTE]
				if erro(teste):
					print_string += """<font color="red">%s</font> """ % questao
				else:
					print_string += """%s """ % questao
		print_string += """</p></td></tr>"""
		lista_submissoes.append(print_string)
	print_string += """</table></body></div>"""

	return print_string

def sumarizacao(dict_mat, dict_quest, datainicio, datafim, questao_sumarizada, turma_analisada):
	
	"""
	Processa os dados dos dicionarios, retornando
	uma sumarizacao (acertos, erros, nao_submissoes) 
	sobre uma determinada questao no periodo de tempo passado.
	"""
	
	submissoes_aluno, fizeram_certa, fizeram_errada, nao_fizeram = [], set(), set(), set()
	for aluno in turma_analisada:
		if questao_sumarizada not in dict_quest or aluno not in dict_quest[questao_sumarizada]:
			nao_fizeram.add(aluno)
			continue
		for indice in range(len(dict_mat[aluno])-1,-1,-1):

			questao = dict_mat[aluno][indice][IND_QUESTAO]
			teste = dict_mat[aluno][indice][IND_TESTE]
			if questao == questao_sumarizada:

				if erro(teste):
					submissoes_aluno.append("%sE" % questao)
					if aluno not in fizeram_certa:
						fizeram_errada.add(aluno)
				else:
					submissoes_aluno.append("%s" % questao)
					if aluno not in fizeram_errada:
						fizeram_certa.add(aluno)

	certas = len(fizeram_certa)
	erradas = len(fizeram_errada)
	num_nao_fizeram = len(nao_fizeram)
	sumario = [certas, fizeram_certa, erradas, fizeram_errada, num_nao_fizeram, nao_fizeram]

	return sumario

def grafico(sumario, questao_sumarizada, datainicio, datafim, dict_alunos):
	
	"""
	Template que gera a string html do grafico da questao
	cujos dados foram sumarizados por sumarizacao().
	"""
	
	grafico_values = {
	"certas" : sumario[0],
	"erradas" : sumario[2],
	"num_nao_fizeram" : sumario[4],
	"questao_sumarizada" : questao_sumarizada,
	"sumario1" : sumario[1],
	"sumario3" : sumario[3],
	"sumario5" : sumario[5],
	"datainicial" : datetime.strftime(datainicio, "%d%m%Y"),
	"df" : datetime.strftime(datafim, "%d%m%Y"),
	"alunos" : dict_alunos
	}
	grafico = jinja_environment.get_template("ConsoleTemplates/grafico.html")

	return grafico.render(grafico_values)

def tabela(dict_mat, dict_quest, horainicio, datainicio, datafim, horafim, lista_questoes, turma, turma_analisada, dict_alunos):
	
	"""
	Processa os dados retornando uma tabela html que indica
	o acerto ou erro da ultima submissao de questoes especificas
	"""
	
	df = datetime.strftime(datafim, "%d%m%Y")
	questoes_tabela = set()
	for question in lista_questoes:
		questoes_tabela.add(int(question))

	lista_ordenada = sorted(questoes_tabela)
	tabelahtml_values = {
	"lista_ordenada" : lista_ordenada,
	"datainicio" : datetime.strftime(datainicio, "%d%m%Y"),
	"horainicio" : horainicio,
	"datafim" : datetime.strftime(datafim, "%d%m%Y"),
	"horafim" : horafim,
	"turma" : turma
	}        
	tabelahtml = jinja_environment.get_template("ConsoleTemplates/tabela.html")
	tabela_head = tabelahtml.render(tabelahtml_values)

	tabela_body = """"""
	for aluno in turma_analisada:
		tabela_body += """<tr><td onClick="document.location.href='/report?data=%s&df=%s&matriculas=%s';" style="cursor:pointer;cursor:hand" title="%s" onMouseover="this.bgColor='#DBDBDB';"onMouseout="this.bgColor='#FFFFFF';" width="100" align="center"><p class="helvetica" style="line-height:20px; font-size:14px;"><a style="color:blue; font-weight:bold; text-decoration: none;">%s</a></td>""" % (datetime.strftime(datainicio, "%d%m%Y"), df, aluno, u"Matrícula: " + aluno + ". TT" + dict_alunos[aluno][1] + ", TP" + dict_alunos[aluno][2], dict_alunos[aluno][NOME])
		for questao in sorted(questoes_tabela):
			if str(questao) not in dict_quest or aluno not in dict_quest[str(questao)]:
				tabela_body += """<td bgcolor=#5C5C5C></td>"""
			else:
				for indice in range(len(dict_mat[aluno])-1,-1,-1):
					quest = int(dict_mat[aluno][indice][IND_QUESTAO])
					teste = dict_mat[aluno][indice][IND_TESTE]
					if quest == questao:
						if erro(teste):
							tabela_body += """<td bgcolor=#FF0000></td>"""
						else:
							tabela_body += """<td bgcolor=#00FF00></td>"""
						break
		tabela_body += """</tr>"""
	tabela_end = """</table></div></body></html>"""
	tabela = """<div align="center">""" + tabela_head + tabela_body + tabela_end + """</div>"""

	return tabela

class Console(webapp2.RequestHandler):
	def get(self):
		
		"""
		Coleta o pacote de dados (arquivo ou url)
		"""
		
		acesso = True
		if not DEBUG:
			try:
				info = get_data()
			except:
				info = open("Recursos/resultados_teste.txt")
				acesso = False
				erro_acesso = jinja_environment.get_template("ConsoleTemplates/erro_acesso.html")
		else:
			info = open("Recursos/resultados_teste.txt")
			
		""" Parametros e tratamento de entrada """
		
		self.response.headers["Content-Type"] = "text/html; charset=utf-8"

		diferenca_tz = timedelta(0, 3 * 3600)
		hoje = datetime.now() - diferenca_tz
		
		""" Tratamento Parametro Hora Inicio"""
		
		horainicio = self.request.get("hi",default_value = "")
		if not horainicio:
			if 8 <= hoje.hour <= 17:
				horainicio_intervalo = "%s:00" % ("%02d" % (hoje.hour - (hoje.hour % 2)))
				horainicio = timedelta(0, (hoje.hour - (hoje.hour % 2)) * 3600)
			else:
				horainicio_intervalo = "00:00"
				horainicio = timedelta(0, 0)
		else:
			hora = "%02d" % int(horainicio[0:2])
			minutos = "%02d" % int(horainicio[2:4])
			horainicio_intervalo = "%s:%s" % ("%02d" % int(hora), "%02d" % int(minutos))
			horainicio = timedelta(0, (int(hora) * 3600) + (int(minutos) * 60))
		param_horainicio = horainicio_intervalo.replace(":","")

		""" Tratamento Parametro Data Inicio """
		
		datainicio = self.request.get("di",default_value = "")
		if not datainicio:
			datainicio = datetime(hoje.year, hoje.month, hoje.day) + horainicio
		else:
			datainicio = datetime.strptime(datainicio, "%d%m%Y") + horainicio
		
		""" Tratamento Parametro Hora Fim """
		
		horafim = self.request.get("hf",default_value = "")
		if not horafim:
			horafim = timedelta(0, (hoje.hour * 3600) + (hoje.minute * 60) + hoje.second)
			param_horafim = "%04d" % int("%s%s" % (hoje.hour, hoje.minute))
		else:
			hora = horafim[0:2]
			minutos = horafim[2:4]
			horafim = timedelta(0, (int(hora) * 3600) + (int(minutos) * 60))
			param_horafim = "%s%s" % (hora, minutos)
		
		""" Tratamento Parametro Data Fim """
		
		datafim = self.request.get("df",default_value = "")
		if not datafim:
			datafim = datetime(hoje.year, hoje.month, hoje.day) + horafim
		else:
			datafim = datetime.strptime(datafim, "%d%m%Y") + horafim

		(dict_mat, dict_quest) = processa_dados(datainicio, datafim, info)
		
		""" Tratamento Parametro Questoes """
		
		questoes = self.request.get("q", default_value = "")
		lista_questoes = []
		for question in questoes.strip(" ").split(","):
			lista_questoes.append(question)
		questao_sumarizada = lista_questoes[0]
		
		""" Tratamento Dicionario Alunos """
		
		alunos = open("Recursos/dados_alunos.txt")
		dict_alunos = {}
		for info_aluno in alunos:
			info_aluno = info_aluno.strip("\n\r").split(",")
			mat = info_aluno[0]
			dict_alunos[mat] = info_aluno
		
		""" Tratamento Parametro Turma """
		
		matricula_inexistente = False
		turma = self.request.get("trm",default_value = "")
		turma_analisada = set()
		if turma:
			if turma.upper() in ["TP1","TP2","TP3","TP4","TP5"]:
				for aluno in dict_alunos:
					if dict_alunos[aluno][2] == turma[2]:
						turma_analisada.add(aluno)
			elif turma.upper() in ["TT1","TT2","TT3"]:
				for aluno in dict_alunos:
					if dict_alunos[aluno][1] == turma[2]:
						turma_analisada.add(aluno)
			else:
				lista_turma = turma.strip(" ").split(",")
				for aluno in lista_turma:
					if aluno not in dict_alunos:
						matricula_inexistente = True
						bad_mat = aluno
						break
					else:
						turma_analisada.add(aluno)
		else:
			for matricula in dict_mat.keys():
				turma_analisada.add(matricula)

		# sorted(dict_alunos.values(), key=lambda aluno: aluno[3])
		sumario = sumarizacao(dict_mat, dict_quest, datainicio, datafim, questao_sumarizada, turma_analisada)
		
		""" Prints layout e cabecalho """

		print_data_hora = hoje.strftime("%d/%m/%Y, %H:%M:%S")
		print_intervalo = u"Submissões no intervalo (Das %s de %s às %s):" % (horainicio_intervalo, datetime.strftime(datainicio, "%d/%m/%Y"), datetime.strftime(datafim, "%H:%M de %d/%m/%Y"))
		navigation = jinja_environment.get_template("/Static/Templates/navigation.html")
		self.response.out.write(navigation.render())
		if not acesso:
			self.response.out.write(erro_acesso.render())
		cabecalho_values = {
			"print_data_hora" : print_data_hora,
			"print_intervalo" : print_intervalo
		}
		cabecalho = jinja_environment.get_template("ConsoleTemplates/cabecalho.html")
		self.response.out.write(cabecalho.render(cabecalho_values))
		""" Logica de funcionamento """

		if matricula_inexistente:
			self.response.out.write(u"""<p class="helvetica" style="text-align:center; font-size:30px; font-weight:bold; color:red">(Bad Request) - Matrícula: %s</a>""" % bad_mat)
		else:
			if not questoes:
				self.response.out.write(lista_submissoes(dict_mat, datainicio, datafim, turma_analisada, dict_alunos))

			elif len(lista_questoes) == 1:
				self.response.out.write(grafico(sumario, questao_sumarizada, datainicio, datafim, dict_alunos))
			else:
				self.response.out.write(tabela(dict_mat, dict_quest, param_horainicio, datainicio, datafim, param_horafim, lista_questoes, turma, turma_analisada, dict_alunos))
		
		formularios = jinja_environment.get_template("ConsoleTemplates/formularios.html")
		self.response.out.write(formularios.render())

class RefreshData(webapp2.RequestHandler):
	def get(self):
		self.response.out.write("teste")
		
app = webapp2.WSGIApplication([("/", Console), ("/refreshdata", RefreshData)], debug=DEBUG)
